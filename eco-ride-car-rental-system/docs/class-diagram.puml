@startuml EcoRideCarRentalClassDiagram

' ===================== DOMAIN LAYER =====================

class KU2559603Vehicle <<abstract>> {
  protected String vehicleId
  protected String model
  protected Category category
  protected AvailabilityStatus availabilityStatus

  + getVehicleId() : String
  + getModel() : String
  + getCategory() : Category
  + getAvailabilityStatus() : AvailabilityStatus
  + markAvailable() : void
  + markReserved() : void
  + markUnderMaintenance() : void
}

class KU2559603HybridCar {
  - double batteryKWh
  - double efficiencyKmPerL
}

class KU2559603ElectricCar {
  - double batteryKWh
  - double chargeTimeHours
}

class KU2559603LuxurySUVCar {
  - String features
  - boolean driverIncluded
}

class KU2559603CompactPetrolCar {
  - double engineCapacityL
  - String transmission
}

KU2559603Vehicle <|-- KU2559603HybridCar
KU2559603Vehicle <|-- KU2559603ElectricCar
KU2559603Vehicle <|-- KU2559603LuxurySUVCar
KU2559603Vehicle <|-- KU2559603CompactPetrolCar

KU2559603Vehicle --> Category
KU2559603Vehicle --> AvailabilityStatus


' ===================== CUSTOMER LAYER =====================

class KU2559603Customer <<abstract>> {
  protected String customerId
  protected String name
  protected String contact
  protected String email

  + getCustomerId() : String
  + getName() : String
  + getContact() : String
  + getEmail() : String
}

class KU2559603LocalCustomer {
  - String nic
}

class KU2559603ForeignCustomer {
  - String passport
  - String nationality
}

KU2559603Customer <|-- KU2559603LocalCustomer
KU2559603Customer <|-- KU2559603ForeignCustomer


' ===================== BOOKING & INVOICE =====================

class KU2559603Booking {
  - String bookingId
  - LocalDateTime createdAt
  - LocalDate startDate
  - LocalDate endDate
  - int totalKm
  - BigDecimal deposit
  - BookingStatus status
  - KU2559603Customer customer
  - KU2559603Vehicle vehicle

  + rentalDays() : int
  + freeKmTotal() : int
  + calculateBasePrice() : BigDecimal
  + calculateExtraKmCharge() : BigDecimal
  + calculateDiscount() : BigDecimal
  + calculateTax() : BigDecimal
  + calculateFinalAmount() : BigDecimal
  + cancelBooking() : void
  + complete() : void
}

KU2559603Booking "1" --> "1" KU2559603Customer : customer
KU2559603Booking "1" --> "1" KU2559603Vehicle : vehicle
KU2559603Booking --> BookingStatus

class KU2559603Invoice {
  - String invoiceId
  - LocalDateTime createdAt
  - KU2559603Booking booking
  protected BigDecimal basePrice
  protected BigDecimal extraKmCharge
  protected BigDecimal discount
  protected BigDecimal tax
  protected BigDecimal depositDeducted
  protected BigDecimal finalPayable

  + getFinalPayable() : BigDecimal
}

KU2559603Invoice "1" --> "1" KU2559603Booking : booking


enum BookingStatus {
  ACTIVE
  CANCELLED
  COMPLETED
}

enum AvailabilityStatus {
  AVAILABLE
  RESERVED
  UNDER_MAINTENANCE
}

enum Category {
  COMPACT_PETROL
  HYBRID
  ELECTRIC
  LUXURY_SUV
  + getDisplayName() : String
}


' ===================== REPOSITORIES =====================

interface KU2559603VehicleRepository {
  + save(v: KU2559603Vehicle)
  + findById(id: String) : Optional<KU2559603Vehicle>
  + findAll() : List<KU2559603Vehicle>
  + delete(id: String)
  + findAvailableByCategory(c: Category) : List<KU2559603Vehicle>
}

interface KU2559603CustomerRepository {
  + save(c: KU2559603Customer)
  + findById(id: String) : Optional<KU2559603Customer>
  + findAll() : List<KU2559603Customer>
  + findByNameContains(n: String) : List<KU2559603Customer>
}

interface KU2559603BookingRepository {
  + save(b: KU2559603Booking)
  + findById(id: String) : Optional<KU2559603Booking>
  + findAll() : List<KU2559603Booking>
  + findByDate(d: LocalDate) : List<KU2559603Booking>
}

class KU2559603InMemoryVehicleRepository
class KU2559603InMemoryCustomerRepository
class KU2559603InMemoryBookingRepository

KU2559603InMemoryVehicleRepository -|> KU2559603VehicleRepository
KU2559603InMemoryCustomerRepository -|> KU2559603CustomerRepository
KU2559603InMemoryBookingRepository -|> KU2559603BookingRepository

KU2559603VehicleRepository "1" --> "*" KU2559603Vehicle
KU2559603CustomerRepository "1" --> "*" KU2559603Customer
KU2559603BookingRepository "1" --> "*" KU2559603Booking


' ===================== SERVICE LAYER =====================

class KU2559603BookingPolicy {
  + ensureCanBook(v: KU2559603Vehicle, start: LocalDate) : void
  + ensureCanAmendOrCancel(b: KU2559603Booking) : void
}

class KU2559603PricingService {
  + calculateBasePrice(b: KU2559603Booking) : BigDecimal
  + calculateExtraKmCharge(b: KU2559603Booking) : BigDecimal
  + calculateDiscount(b: KU2559603Booking) : BigDecimal
  + calculateTax(b: KU2559603Booking) : BigDecimal
}

class KU2559603CarRentalSystem {
  - KU2559603VehicleRepository vehicleRepo
  - KU2559603CustomerRepository customerRepo
  - KU2559603BookingRepository bookingRepo
  - KU2559603BookingPolicy policy
  - Map<String,String> adminUsers

  + addAdmin(id:String, pw:String)
  + authenticateAdmin(id:String, pw:String) : boolean
  + seedAdmins()
  + addVehicle(v:KU2559603Vehicle)
  + updateVehicle(v:KU2559603Vehicle)
  + removeVehicle(id:String)
  + listVehicles() : List<KU2559603Vehicle>
  + changeAvailability(id:String, st:AvailabilityStatus)
  + addCustomer(c:KU2559603Customer)
  + findCustomer(id:String) : Optional<KU2559603Customer>
  + searchCustomersByName(name:String) : List<KU2559603Customer>
  + listAvailableByCategory(c:Category) : List<KU2559603Vehicle>
  + bookByCategory(cid:String, cat:Category, start:LocalDate, days:int, km:int) : KU2559603Booking
  + bookSpecific(cid:String, vid:String, start:LocalDate, days:int, km:int) : KU2559603Booking
  + updateBooking(id:String, newStart:LocalDate, newDays:Integer, newKm:Integer) : KU2559603Booking
  + cancelBooking(id:String)
  + completeAndInvoice(id:String) : KU2559603Invoice
  + findBookingById(id:String) : Optional<KU2559603Booking>
  + searchBookingsByNameOrId(q:String) : List<KU2559603Booking>
  + viewBookingsByDate(d:LocalDate) : List<KU2559603Booking>
  + generateVehicleId() : String
  + seedVehicles()
}

KU2559603CarRentalSystem --> KU2559603VehicleRepository
KU2559603CarRentalSystem --> KU2559603CustomerRepository
KU2559603CarRentalSystem --> KU2559603BookingRepository
KU2559603CarRentalSystem --> KU2559603BookingPolicy
KU2559603CarRentalSystem --> KU2559603PricingService

KU2559603CarRentalSystem "1" --> "*" KU2559603Vehicle : manages
KU2559603CarRentalSystem "1" --> "*" KU2559603Customer : manages
KU2559603CarRentalSystem "1" --> "*" KU2559603Booking : manages


' ===================== CLI & UTIL =====================

class KU2559603IdGenerator {
  + shortId() : String
}

class KU2559603ConsoleUI {
  - KU2559603CarRentalSystem system
  + start() : void
}

KU2559603ConsoleUI --> KU2559603CarRentalSystem : uses
KU2559603IdGenerator ..> KU2559603Booking : "creates bookingId"
KU2559603IdGenerator ..> KU2559603Invoice : "creates invoiceId"

@enduml
